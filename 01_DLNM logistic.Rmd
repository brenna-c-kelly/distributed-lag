---
title: "01_DLNM logistic"
author: "Brenna Kelly"
date: "2025-07-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, results='hide'}

library(dlnm)
library(tidyr)
library(dplyr)
library(stringr)
library(splines)
library(lubridate)
library(data.table)

```


```{r, echo = FALSE, results='hide'}

birth <- read.csv("data/birth_exposures_with_confounders.csv") |>
  select(!momage)

# get race, ethnicity
mom_2013 <- fread('/Users/brenna/Downloads/births 2013+.csv')
mom_2016 <- fread('/Users/brenna/Downloads/births 2016+.csv')

mom_both <- rbind(mom_2013, mom_2016)

# clean race, ethnicity
mom <- mom_both |>
  mutate(ethn = case_when(MomHispanicOrigin == 1 | MomHispanicMex == 1 |
                            MomHispanicCuban == 1 | MomHispanicPuertoRican == 1 |
                            MomHispanicOther == 1 | MomHispanicOtherSpec != "" |
                            !MomHispanicOtherSpec %in% c("*", "") ~ # primacy
                            "hispanic"),
         ethn = ifelse(is.na(ethn), "not hispanic", ethn),
         race = case_when(MomRaceWhite == 1 ~ "white",
                          MomRaceBlack == 1 ~ "black",
                          MomRaceAmIndian == 1 ~ "amindian",
                          MomRaceChinese == 1 | MomRaceJapanese == 1 |
                            MomRaceFilipino == 1 | MomRaceOtherAsian == 1 |
                            MomRaceAsianIndian == 1 | MomRaceKorean == 1 |
                            MomRaceVietnamese == 1 ~ "asian",
                          MomRaceHawaiian == 1 | MomRaceSamoan == 1 |
                            MomRaceGuamanian == 1 | MomRacePacIslander == 1 |
                            MomRaceTongan == 1 ~ "nhopi",
                          MomRaceOther == 1 | MomRaceOtherSpec1 == 1 |
                            MomRaceOtherSpec2 == 1 | MomRaceUnknown == 1 ~ "other"),
         race = ifelse(is.na(race), "unknown", race), # note, only 160 with unknown race
         race_ethn = ifelse(ethn == "hispanic", "hispanic", race),
         # ^for model, gives primacy to hispanic
         race_ethn = ifelse(race_ethn == "unknown", "other", race_ethn)) |>
         # ^combines other and unknown for model
  rename_with(tolower) |>
  select(momid, birthccyy, birthmm, race, ethn, race_ethn,
         hypertension, diabetes, momage) |>
  mutate(momid = as.numeric(momid),
         momage = as.numeric(momage),
         diabetes_pre = as.factor(
           ifelse(diabetes == "I", 1, 0)), # confirming code
         hypertension_pre = as.factor(
           ifelse(hypertension == "C", 1, 0)), # chronic hypertension
         hypertension_gest = as.factor(
           ifelse(hypertension == "H", 1, 0)), # gestational hypertension
         preeclampsia = as.factor(
           ifelse(hypertension == "P", 1, 0)), # preeclampsia
         eclampsia = as.factor(
           ifelse(hypertension == "E", 1, 0))) |> 
  mutate(momage_c = momage - mean(momage, na.rm = TRUE))

prop.table(table(mom$hypertension_pre, 
                 mom$diabetes_pre)) # most people don't have both; minimal correlation

# join race information with birth dataset

birth <- merge(birth, mom, by = c("momid", "birthccyy", "birthmm"))

## need to add SGA
case <- read.csv("data/clean_case_data.csv")

birth <- merge(birth, case[, c("momid", "birthccyy", "birthmm", "sga")], 
               by = c("momid", "birthccyy", "birthmm"))

```


```{r}

library(ggplot2)

prop.table(
  table(birth$sga,
        birth$hypertension_gest))

prop.table(table(birth$eclampsia))

birth$plac_insuff <- case_when(birth$preeclampsia == 1 ~ 1,
                               birth$eclampsia == 1 ~ 1,
                               birth$hypertension_gest == 1 ~ 1,
                               birth$sga == "small" ~ 1)
birth$plac_insuff <- factor(
  as.factor(ifelse(is.na(birth$plac_insuff), 0, 1)),
  labels = c("Without PI", "With PI"))

theme_set(theme_minimal())

# how is PI correlated with preterm birth
birth |>
  group_by(gestation) |>
  count(plac_insuff) |>
  ggplot(aes(x = gestation, y = n, group = plac_insuff, fill = plac_insuff)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ plac_insuff, nrow = 2, scales = "free_y")

# proportion with PI at each week of delivery
prop_pi <- birth |>
  group_by(gestation, plac_insuff) |>
  count() |>
  pivot_wider(names_from = plac_insuff, values_from = n) |>
  mutate(`With PI` = ifelse(is.na(`With PI`), 0, `With PI`)) |>
  mutate(pi_prop = `With PI` / (`With PI` + `Without PI`))

plot(prop_pi$gestation, prop_pi$pi_prop)

birth$preterm = ifelse(birth$gestation < 37, 1, 0)

glm(plac_insuff ~ preterm, data = birth,
    family = binomial(link = "log"))
exp(0.8722)

birth |>
  group_by(gestation) |>
  count(hypertension_gest,
        sga) |>
  ggplot(aes(x = gestation, y = n, group = hypertension_gest, fill = sga)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ hypertension_gest, scales = "free")

table(birth$hypertension_gest)


```


Additional cleaning:

```{r, echo = FALSE, results='hide'}

# contains subsequent pregnancies
# length(unique(birth$momid))

# drop subsequent pregnancies
birth_sorted <- birth |>
  arrange(momid, birthccyy, birthmm)

birth <- birth_sorted[match(unique(birth_sorted$momid), birth_sorted$momid), ]

# try to make long
birth_l <- birth |>
  pivot_longer(names_to = "exposure_week", cols = 16:367)

# tidy up
birth_l <- birth_l |>
  select(!c(statefilenumber, geo_score, full_date))

# create birth date
birth_l <- birth_l |>
  mutate(date = mdy(paste0(str_pad(birthmm, width = 2, pad = "0", side = "left"),
                           str_pad(birthdd, width = 2, pad = "0", side = "left"),
                           str_pad(birthccyy, width = 2, pad = "0", side = "left"))))

# dates of exposure
birth_l$gestation_week <- str_sub(birth_l$exposure_week, 
                                  start = (nchar(birth_l$exposure_week) - 1),
                                  end = nchar(birth_l$exposure_week)) |>
  as.numeric()

# make it person-week instead of person-pollutant-week
birth_l$pollutant <- str_sub(birth_l$exposure_week, start = 0, 
                             end = (nchar(birth_l$exposure_week) - 3))

# remove NA values, which are exposures which occur after birth
birth_l <- birth_l |>
  filter(!is.na(value))

# get the outcome by momid
preterm_momid <- birth_l |>
  select(c(momid, gestation, geoid, poverty_rate, race, ethn, race_ethn,
           diabetes_pre, hypertension_pre, momage_c)) |>
  distinct()

birth_pt <- birth_l |> # person-time
  pivot_wider(id_cols = c("momid", "date", "gestation_week"), 
              names_from = pollutant, values_from = value)
# this drops confounders, outcome, etc, but we can recover those later

# gives us the outcome (gestational age at birth)
birth_pt <- merge(birth_pt, preterm_momid, by = "momid")

birth_pt$gestation_wk_end <- birth_pt$date - (7 * birth_pt$gestation_week)

birth_pt$gestation_wk_start <- birth_pt$gestation_wk_end - 7

head(birth_pt)

```


Adding inversions data:

```{r, echo = FALSE, results='hide'}

inv <- read.csv("data/inversion_data.csv")

names(inv) <- tolower(names(inv))

inv$date <- mdy(inv$date)

# basically it's Ogden, Provo or SLC
table(inv$station)

# categorize; inversion or not
# inv$inversion <- ifelse(inv$era.adj.cap == "TRUE", "inversion", "no inversion") # MAYBE = NO
inv$inversion <- ifelse(inv$era.adj.cap %in% c("TRUE", "Maybe"), "inversion", "no inversion") # MAYBE = YES

inv_dates <- inv |>
  filter(inversion == "inversion") |>
  select(date, station)

inv_dates$inversion <- 1

# test$week <- week(inv_dates$date)

# needs to be a spatiotemporal join, although a crude one
# - could use census data to start, based on county
#     - Davis (001) and Weber (057) = Ogden
#     - Utah (049) = Provo
#     - Salt Lake (035) = SLC
#     - Else = no inversions; could restrict analysis to these locations first
# - eventually, could look at distance from station to grid cells, to deal with boundary issues
#     - need coordinates for this

# get only births in counties with inversion models
birth_inv <- birth_pt |>
  mutate(county_fips = str_sub(geoid, start = 3, end = 5)) |>
  filter(county_fips %in% c("011", "057", "049", "035")) |>
  mutate(inv_station = case_when(county_fips %in% c("011", "057") ~ "OGD",
                                 county_fips == "049" ~ "PVO",
                                 county_fips == "035" ~ "SLC"))

# probably the way to go is disaggregate to daily, then re-aggregate to weekly with n(inv_days)

birth_days <- setDT(birth_inv)[ , list(momid = momid, 
                                       date = seq(gestation_wk_start, 
                                                  gestation_wk_end, by = "day"),
                                       inv_station, gestation_week, #geoid,
                                       poverty_rate, race, ethn, race_ethn,
                                       diabetes_pre, hypertension_pre, momage_c),
                                by = 1:nrow(birth_inv)]

birth_days_inv <- merge(birth_days, inv_dates, by.x = c("date", "inv_station"), 
                        by.y = c("date", "station"), all.x = TRUE)

birth_days_inv$inversion <- ifelse(is.na(birth_days_inv$inversion), 0, birth_days_inv$inversion)

birth_days_inv <- birth_days_inv |>
  group_by(momid, gestation_week, inversion) |>
  tally()

# think I can just take the inversion count?
birth_days_inv <- birth_days_inv |>
  filter(inversion == 1) #|>
  # select(!inversion)

head(birth_days_inv)

birth_inv <- merge(birth_inv, birth_days_inv, by = c("momid", "gestation_week"), all.x = TRUE)

birth_inv$n <- ifelse(is.na(birth_inv$n), 0, birth_inv$n - 1)

birth_inv$inversion <- ifelse(is.na(birth_inv$inversion), 0, 1)

# table(birth_inv$n)

# prop.table(table(birth_inv$n != 0)) # proportion of pregnancy weeks with inversion exposure

```

```{r, echo = FALSE, results='hide'}

# light cleaning
birth_inv$preterm <- relevel(
  as.factor(ifelse(birth_inv$gestation <= 37, 
                   "preterm/early", "late/term")), ref = "late/term")

birth_inv$n <- as.factor(birth_inv$n)

birth_inv$gestation_week <- as.factor(birth_inv$gestation_week)

birth_inv$race_ethn <- relevel(as.factor(birth_inv$race_ethn), ref = "white")

birth_inv$early_preterm <- ifelse(birth_inv$gestation <= 37, 1, 0) # include "very" early and early

birth_inv$max_inv_pm <- ifelse(birth_inv$n != 0, birth_inv$max_pm, 0)

# how many person-weeks don't exist for later gestation?
aggregate(birth_inv$early_preterm, by = list(birth_inv$gestation_week), FUN = sum)

# only first 20 weeks; or not; using person-time, don't filter
birth_inv_20 <- birth_inv# |>
  # filter(gestation >= 20)

# check missingness
summary(birth_inv_20[which(birth_inv_20$gestation_week == 32), "max_inv_pm"])

# poverty is missing for 514 folks; fix later
summary(birth_inv_20$poverty_rate)

```

DLNM model:

```{r, out.width="150%"}

# exclude prior to 20 and after 42
birth_inv_20 <- birth_inv_20 |>
  filter(gestation >= 20) |>
  filter(gestation < 42)

# create crossbasis for exposure-lag-response
# cb1.intx <- crossbasis(birth_inv_20$max_inv_pm, 
                      lag = 37, 
                      argvar = list(fun = "bs", knots = 4,
                                    Boundary.knots = c(0, 110)), 
                      arglag = list(fun = "bs", knots = 4))
summary(cb1.intx) # this describes the crossbasis functions and basis for the predictor and lag

# inversion
cb1.inv <- crossbasis(birth_inv_20$inversion,
                      lag = 37,
                      # argvar = list(fun = "bs", knots = 3),
                      arglag = list(fun = "bs", knots = 3))
summary(cb1.inv) # this describes the crossbasis functions and basis for the predictor and lag

# any PM2.5
cb1.pm25 <- crossbasis(birth_inv_20$max_pm, 
                      lag = 37, 
                      argvar = list(fun = "bs", knots = 4), 
                      arglag = list(fun = "bs", knots = 4))
summary(cb1.pm25) # this describes the crossbasis functions and basis for the predictor and lag

# model
model1 <- glm(early_preterm ~ cb1.intx + 
                cb1.pm25 + cb1.inv +
                diabetes_pre + hypertension_pre + momage_c,
                # poverty_rate + race_ethn, # adjusting for confounders
                family = "binomial", birth_inv_20)
summary(model1)
# intx bs, inv ns, pm bs
# AIC: 1149884
# intx bs, inv bs, pm bs
# AIC: 1149884
# intx bs, inv ns, pm ns
# AIC: 1150049
# intx bs, inv ns, pm bs
# AIC: 1149886

# 3 knots: 1150449
# 4 knots: 1150190

# library(regclass)
# VIF(model1)

# get predictions for each exposure-lag
pred1.inv_pm25 <- crosspred(cb1.intx, model1, at = 1:10*11,#0:120, 
                       bylag = 1, cumul = TRUE, cen = 0)

pred1.inv <- crosspred(cb1.inv, model1, at = 0:1, bylag = 1,
                       cumul = TRUE, cen = 0)#, #at = 0:120,
                       # bylag = 1, cen = 0)#, cumul = TRUE, cen = 0)

pred1.pm25 <- crosspred(cb1.pm25, model1, at = 1:10*11, 
                       bylag = 1, cumul = TRUE, cen = 0)

pred1.inv_pm25$matRRfit

# 30, 110
IRR = 1.547264 / (1.025687 + 0.9866442)
# IRR
RERI = 1.547264 - 1.025687 - 0.9866442 + 1
# RERI / 1.547264
# 1, 110
IRR = 0.7051769 / (1.158300 + 0.9958787)
# IRR
RERI = 0.7051769 - 1.158300 - 0.9958787 + 1
# RERI / 1.547264


plot(pred1.inv_pm25)
plot(pred1.pm25, var = 100)

plot(pred1.inv)
plot(pred1.inv, var = 1)

# str(pred1.inv)

# full exposure-lag-response surface
plot(pred1.inv_pm25, zlab = "OR of preterm birth", 
     ylab = "Gestational week", xlab = "Inversion-specific PM2.5",
     col = "white")

plot(pred1.pm25, var = 150)

# lag-response curves at specific exposure thresholds
# based on the lawer end of each AQI category
# https://www.airnow.gov/aqi/aqi-basics/

# axis labels
main_AQI50 = expression(paste("Inversion PM"[2.5], 
                                 " = 9 µg/m" ^ 2, 
                                 " (AQI = 50)"))
main_AQI100 = expression(paste("Inversion PM"[2.5], 
                                  " = 35 µg/m" ^ 2, 
                                  " (AQI = 100)"))
main_AQI150 = expression(paste("Inversion PM"[2.5], 
                                  " = 55 µg/m" ^ 2, 
                                  " (AQI = 150)"))
main_AQI200 = expression(paste("Inversion PM"[2.5], 
                                  " = 119 µg/m" ^ 2, 
                                  " (AQI = 200)"))
# curves # export with ht = 15
par(mfrow = c(4, 1))
plot(pred1.inv, var = 119, ylim = c(0.85, 1.65), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week", main = main_AQI200)
plot(pred1.inv, var = 55, ylim = c(0.85, 1.65), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week", main = main_AQI150)
plot(pred1.inv, var = 35, ylim = c(0.85, 1.65), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week", main = main_AQI100)
plot(pred1.inv, var = 9, ylim = c(0.85, 1.65), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week", main = main_AQI50)
dev.off()

###############
# given these plots, what exposure-lag-response effects would you want to interpret?
# e.g., weeks 0-6 and 24-32 when AQI = 100
###############

```

### sum up, for total effect  
(in the near future)

### heatmaps

```{r}

# plot(pred3.temp, "contour", xlab="Temperature", key.title=title("RR"),
# plot.title=title("Contour plot",xlab="Temperature",ylab="Lag"))

# get predictions for each exposure-lag
pred1.inv_pm25 <- crosspred(cb1.intx, model1, at = 1:11*10,#0:120, 
                       bylag = 1, cumul = TRUE, cen = 0)
# plot(pred1.inv_pm25)

rr_mat <- pred1.inv_pm25$matRRfit |> #cplist$`late`$matfit |> #pred1.wf_days$matRRfit |>
  reshape2::melt() |>
  rename(exposure = Var1,
         lag = Var2,
         RR = value) |>
  # mutate(RR = exp(RR)) |>
  mutate(lag = as.numeric(gsub("lag", "", lag))) |>
  # rename(exposure = Var1,
  #        lag = Var2,
  #        RR = value) |>
  mutate(lag = as.numeric(gsub("lag", "", lag)))

ci_lo_mat <- pred1.inv_pm25$matRRlow |> #cplist$`late`$matlow |>#pred1.wf_days$matRRlow |>
  reshape2::melt() |>
  rename(exposure = Var1,
         lag = Var2,
         CI_lo = value) |>
  # mutate(CI_lo = exp(CI_lo)) |>
  mutate(lag = as.numeric(gsub("lag", "", lag))) |>
  # rename(exposure = Var1,
  #        lag = Var2,
  #        RR = value) |>
  mutate(lag = as.numeric(gsub("lag", "", lag)))

ci_hi_mat <- pred1.inv_pm25$matRRhigh |> #cplist$`late`$mathigh |>#pred1.wf_days$matRRhigh |>
  reshape2::melt() |>
  rename(exposure = Var1,
         lag = Var2,
         CI_hi = value) |>
  # mutate(CI_hi = exp(CI_hi)) |>
  mutate(lag = as.numeric(gsub("lag", "", lag))) |>
  # rename(exposure = Var1,
  #        lag = Var2,
  #        RR = value) |>
  mutate(lag = as.numeric(gsub("lag", "", lag)))

rr <- merge(rr_mat, ci_lo_mat, by = c("exposure", "lag")) |>
  merge(ci_hi_mat, by = c("exposure", "lag"))

rr <- rr |>
  filter(lag != 0)

# statistical significance, for outline
rr$significant <- case_when(rr$CI_lo > 1 & rr$CI_hi > 1 ~ "significant", 
                            rr$CI_lo < 1 & rr$CI_hi < 1 ~ "significant")
rr$significant <- ifelse(is.na(rr$significant), "not", "significant")

# rr_significant <- rr |>
#   filter(significant == "significant")

rr_plot <- ggplot(rr, aes(x = lag, y = exposure, fill = RR)) +
  geom_tile(colour = "gray70", linewidth = 0.0) +
  scale_fill_gradient2(low = "royalblue1", mid = "white", 
                       high = "orangered", midpoint = 1,
                       limits = c(0.49, 1.78)) +
  geom_tile(data = rr[which(rr$significant == "significant"),],
            fill = NA, color = "gray80", size = 0.25) +
  theme_minimal() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Relative Risk of Preterm Birth", 
       x = "Gestational Week",
       y = "Inversion-specific PM2.5 exposure")

ci_lo_plot <- ggplot(ci_lo_mat, aes(x = lag, y = exposure, fill = CI_lo)) +
  geom_tile(colour = "gray70", linewidth = 0.0) +
  scale_fill_gradient2(low = "royalblue1", mid = "white", 
                       high = "orangered", midpoint = 1,
                       limits = c(0.49, 1.78)) +
  theme_minimal() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Lower 95% CI", 
       x = "",
       y = "", fill = "")

ci_hi_plot <- ggplot(ci_hi_mat, aes(x = lag, y = exposure, fill = CI_hi)) +
  geom_tile(colour = "gray70", linewidth = 0.0) +
  scale_fill_gradient2(low = "royalblue1", mid = "white", 
                       high = "orangered", midpoint = 1,
                       limits = c(0.49, 1.78)) +
  theme_minimal() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Upper 95% CI", 
       x = "",
       y = "", fill = "")

library(patchwork)

rr_plot + (ci_hi_plot / ci_lo_plot)+# / plot_spacer()) +
  plot_layout(widths = c(2.5, 1), guides = "collect")


```


### individual results

```{r}

rr |>
  filter(significant == "significant") |>
  filter(lag >= 15) |>
  filter(exposure == 110) |>
  arrange(lag)


# how large of the low risk effects in early pregnancy
rr |>
  filter(significant == "significant") |>
  filter(lag < 10) |>
  filter(exposure > 80) |>
  arrange(RR)


```




#### heatmap of PM2.5

```{r}

# get predictions for each exposure-lag
pred1.pm25 <- crosspred(cb1.pm25, model1, at = 0:12*10,#0:120, 
                        bylag = 1, cumul = TRUE, cen = 0)
plot(pred1.pm25)

rr_mat <- pred1.pm25$matRRfit |> #cplist$`late`$matfit |> #pred1.wf_days$matRRfit |>
  reshape2::melt() |>
  rename(exposure = Var1,
         lag = Var2,
         RR = value) |>
  # mutate(RR = exp(RR)) |>
  mutate(lag = as.numeric(gsub("lag", "", lag))) |>
  # rename(exposure = Var1,
  #        lag = Var2,
  #        RR = value) |>
  mutate(lag = as.numeric(gsub("lag", "", lag)))

ci_lo_mat <- pred1.pm25$matRRlow |> #cplist$`late`$matlow |>#pred1.wf_days$matRRlow |>
  reshape2::melt() |>
  rename(exposure = Var1,
         lag = Var2,
         CI_lo = value) |>
  # mutate(CI_lo = exp(CI_lo)) |>
  mutate(lag = as.numeric(gsub("lag", "", lag))) |>
  # rename(exposure = Var1,
  #        lag = Var2,
  #        RR = value) |>
  mutate(lag = as.numeric(gsub("lag", "", lag)))

ci_hi_mat <- pred1.pm25$matRRhigh |> #cplist$`late`$mathigh |>#pred1.wf_days$matRRhigh |>
  reshape2::melt() |>
  rename(exposure = Var1,
         lag = Var2,
         CI_hi = value) |>
  # mutate(CI_hi = exp(CI_hi)) |>
  mutate(lag = as.numeric(gsub("lag", "", lag))) |>
  # rename(exposure = Var1,
  #        lag = Var2,
  #        RR = value) |>
  mutate(lag = as.numeric(gsub("lag", "", lag)))

rr <- merge(rr_mat, ci_lo_mat, by = c("exposure", "lag")) |>
  merge(ci_hi_mat, by = c("exposure", "lag"))

rr <- rr |>
  filter(lag != 0)

# statistical significance, for outline
rr$significant <- case_when(rr$CI_lo > 1 & rr$CI_hi > 1 ~ "significant", 
                            rr$CI_lo < 1 & rr$CI_hi < 1 ~ "significant")
rr$significant <- ifelse(is.na(rr$significant), "not", "significant")

# rr_significant <- rr |>
#   filter(significant == "significant")

rr_plot <- ggplot(rr, aes(x = lag, y = exposure, fill = RR)) +
  geom_tile(colour = "gray70", linewidth = 0.0) +
  scale_fill_gradient2(low = "royalblue1", mid = "white", 
                       high = "orangered", midpoint = 1,
                       limits = c(0.78, 1.54)) +
  geom_tile(data = rr[which(rr$significant == "significant"),],
            fill = NA, color = "orangered", size = 0.25) +
  theme_minimal() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Relative Risk of Preterm Birth", 
       x = "Gestational Week",
       y = "PM2.5 exposure")

ci_lo_plot <- ggplot(rr, aes(x = lag, y = exposure, fill = CI_lo)) +
  geom_tile(colour = "gray70", linewidth = 0.0) +
  scale_fill_gradient2(low = "royalblue1", mid = "white", 
                       high = "orangered", midpoint = 1,
                       limits = c(0.78, 1.54)) +
  theme_minimal() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Lower 95% CI", 
       x = "",
       y = "", fill = "")

ci_hi_plot <- ggplot(rr, aes(x = lag, y = exposure, fill = CI_hi)) +
  geom_tile(colour = "gray70", linewidth = 0.0) +
  scale_fill_gradient2(low = "royalblue1", mid = "white", 
                       high = "orangered", midpoint = 1,
                       limits = c(0.78, 1.54)) +
  theme_minimal() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Upper 95% CI", 
       x = "",
       y = "", fill = "")

library(patchwork)

rr_plot + (ci_hi_plot / ci_lo_plot)+# / plot_spacer()) +
  plot_layout(widths = c(2.5, 1), guides = "collect")


```

Regardless of PM2.5 concentration or gestational week of exposure, PM2.5 is associated with increased risk of preterm birth, although many of these effects are modest. First trimester exposure (prior to week 13) to even moderate levels of PM2.5 are associated with greater risk of preterm birth. In particular, exposure to 12 micrograms/m3 in week 1 is associated with 27% greater risk (RR: 1.27 95% CI [1.06, 1.53]).


Odds ratios

```{r}
# low PM2.5
overall_9 <- crosspred(cb1.inv_pm25, model1, at = 9, 
                        cumul = FALSE, cen = 0,
                        ci.level = 0.95)

# at weeks 1, 37, and 25
overall_9$matRRfit[2] # lag 1
overall_9$matRRlow[2]
overall_9$matRRhigh[2]
overall_9$matRRfit[38] # lag 38
overall_9$matRRlow[38]
overall_9$matRRhigh[38]
overall_9$matRRfit[26] # lag 25
overall_9$matRRlow[26]
overall_9$matRRhigh[26]


for(i in c(2, 38, 26)) {
  
  print(paste0("For week = ", (i - 1)))
  
  for(j in c(9, 35, 55, 119)) {
    
    print(paste0("For PM2.5 = ", j))
    
    results <- crosspred(cb1.inv_pm25, model1, at = j, 
                        cumul = FALSE, cen = 0,
                        ci.level = 0.95)
    
    print(
      paste0("RR: ",
        round(results$matRRfit[i], 2),
        ", 95% CI [",
        round(results$matRRlow[i], 2),
        ", ",
        round(results$matRRhigh[i], 2),
        "]"
      )
    )
  }
}

# this RR is the overall relative risk, and low/high are the 95% confidence intervals
print("Overall effect of 9 micrograms/m2 of PM2.5")
paste0(round(overall_9$allRRfit[[1]], 2), ", 95% CI [", 
       round(overall_9$allRRlow, 2), ", ", 
       round(overall_9$allRRhigh, 2), "]")

```




Note that at some points, it appears that PM2.5 has a "protective effect". In reality, PM2.5 exposure is unlikely to decrease risk of preterm birth. In this case, it's useful to also look at the cumulative (or overall) effect of exposure. i.e., PM2.5 = 9 in early pregnancy may appear to decrease risk of preterm birth; but if someone were exposed to PM2.5 = 9 for their entire pregnancy, what would the overall effect be?

```{r}

# create crosspredictions at the AQI thresholds see2 above
# AQI = 50
overall_9 <- crosspred(cb1.inv_pm25, model1, at = 9, 
                        cumul = FALSE, cen = 0,
                        ci.level = 0.95)
# this RR is the overall relative risk, and low/high are the 95% confidence intervals
print("Overall effect of 9 micrograms/m3 of PM2.5")
paste0(round(overall_9$allRRfit[[1]], 2), ", 95% CI [", 
       round(overall_9$allRRlow, 2), ", ", 
       round(overall_9$allRRhigh, 2), "]")

# AQI = 100
overall_35 <- crosspred(cb1.inv_pm25, model1, at = 35, 
                        cumul = FALSE, cen = 0,
                        ci.level = 0.95)

print("Overall effect of 35 micrograms/m3 of PM2.5")
paste0(round(overall_35$allRRfit[[1]], 2), ", 95% CI [", 
       round(overall_35$allRRlow, 2), ", ", 
       round(overall_35$allRRhigh, 2), "]")

# AQI = 150
overall_55 <- crosspred(cb1.inv_pm25, model1, at = 55, 
                        cumul = FALSE, cen = 0,
                        ci.level = 0.95)

print("Overall effect of 55 micrograms/m3 of PM2.5")
paste0(round(overall_55$allRRfit[[1]], 2), ", 95% CI [", 
       round(overall_55$allRRlow, 2), ", ", 
       round(overall_55$allRRhigh, 2), "]")

# AQI = 200
overall_119 <- crosspred(cb1.inv_pm25, model1, at = 119, 
                        cumul = FALSE, cen = 0,
                        ci.level = 0.95)

print("Overall effect of 119 micrograms/m3 of PM2.5")
paste0(round(overall_119$allRRfit[[1]], 2), ", 95% CI [", 
       round(overall_119$allRRlow, 2), ", ", 
       round(overall_119$allRRhigh, 2), "]")
# it's very unlikely (and impossible, in our dataset) to be exposed to 119 of inversion PM2.5 for an entire pregnancy, so we wouldn't place much emphasis on this particular interpretation

```
