---
title: "01_WF_DLNM logistic"
author: "Brenna Kelly"
date: "2025-09-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, results='hide'}

library(dlnm)
library(tidyr)
library(dplyr)
library(stringr)
library(splines)
library(lubridate)
library(data.table)

```


```{r, echo = FALSE, results='hide'}

birth <- read.csv("data/birth_exposures_with_confounders.csv") |>
  select(!momage)

# get race, ethnicity
mom_2013 <- fread('/Users/brenna/Downloads/births 2013+.csv')
mom_2016 <- fread('/Users/brenna/Downloads/births 2016+.csv')

mom_both <- rbind(mom_2013, mom_2016)

# clean race, ethnicity
mom <- mom_both |>
  mutate(ethn = case_when(MomHispanicOrigin == 1 | MomHispanicMex == 1 |
                            MomHispanicCuban == 1 | MomHispanicPuertoRican == 1 |
                            MomHispanicOther == 1 | MomHispanicOtherSpec != "" |
                            !MomHispanicOtherSpec %in% c("*", "") ~ # primacy
                            "hispanic"),
         ethn = ifelse(is.na(ethn), "not hispanic", ethn),
         race = case_when(MomRaceWhite == 1 ~ "white",
                          MomRaceBlack == 1 ~ "black",
                          MomRaceAmIndian == 1 ~ "amindian",
                          MomRaceChinese == 1 | MomRaceJapanese == 1 |
                            MomRaceFilipino == 1 | MomRaceOtherAsian == 1 |
                            MomRaceAsianIndian == 1 | MomRaceKorean == 1 |
                            MomRaceVietnamese == 1 ~ "asian",
                          MomRaceHawaiian == 1 | MomRaceSamoan == 1 |
                            MomRaceGuamanian == 1 | MomRacePacIslander == 1 |
                            MomRaceTongan == 1 ~ "nhopi",
                          MomRaceOther == 1 | MomRaceOtherSpec1 == 1 |
                            MomRaceOtherSpec2 == 1 | MomRaceUnknown == 1 ~ "other"),
         race = ifelse(is.na(race), "unknown", race), # note, only 160 with unknown race
         race_ethn = ifelse(ethn == "hispanic", "hispanic", race),
         # ^for model, gives primacy to hispanic
         race_ethn = ifelse(race_ethn == "unknown", "other", race_ethn)) |>
         # ^combines other and unknown for model
  rename_with(tolower) |>
  select(momid, birthccyy, birthmm, race, ethn, race_ethn,
         hypertension, diabetes, momage) |>
  mutate(momid = as.numeric(momid),
         momage = as.numeric(momage),
         diabetes_pre = as.factor(
           ifelse(diabetes == "I", 1, 0)), # confirming code
         hypertension_pre = as.factor(
           ifelse(hypertension == "C", 1, 0)), # chronic hypertension
         hypertension_gest = as.factor(
           ifelse(hypertension == "H", 1, 0)), # gestational hypertension
         preeclampsia = as.factor(
           ifelse(hypertension == "P", 1, 0)), # preeclampsia
         eclampsia = as.factor(
           ifelse(hypertension == "E", 1, 0))) |> 
  mutate(momage_c = momage - mean(momage, na.rm = TRUE))

prop.table(table(mom$hypertension_pre, 
                 mom$diabetes_pre)) # most people don't have both; minimal correlation

# join race information with birth dataset

birth <- merge(birth, mom, by = c("momid", "birthccyy", "birthmm"))

## need to add SGA
case <- read.csv("data/clean_case_data.csv")

birth <- merge(birth, case[, c("momid", "birthccyy", "birthmm", "sga")], 
               by = c("momid", "birthccyy", "birthmm"))

```


```{r}

library(ggplot2)

prop.table(
  table(birth$sga,
        birth$hypertension_gest))

prop.table(table(birth$eclampsia))

birth$plac_insuff <- case_when(birth$preeclampsia == 1 ~ 1,
                               birth$eclampsia == 1 ~ 1,
                               birth$hypertension_gest == 1 ~ 1,
                               birth$sga == "small" ~ 1)
birth$plac_insuff <- factor(
  as.factor(ifelse(is.na(birth$plac_insuff), 0, 1)),
  labels = c("Without PI", "With PI"))

theme_set(theme_minimal())

# how is PI correlated with preterm birth
birth |>
  group_by(gestation) |>
  count(plac_insuff) |>
  ggplot(aes(x = gestation, y = n, group = plac_insuff, fill = plac_insuff)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ plac_insuff, nrow = 2, scales = "free_y")

# proportion with PI at each week of delivery
prop_pi <- birth |>
  group_by(gestation, plac_insuff) |>
  count() |>
  pivot_wider(names_from = plac_insuff, values_from = n) |>
  mutate(`With PI` = ifelse(is.na(`With PI`), 0, `With PI`)) |>
  mutate(pi_prop = `With PI` / (`With PI` + `Without PI`))

plot(prop_pi$gestation, prop_pi$pi_prop)

birth$preterm = ifelse(birth$gestation < 37, 1, 0)

glm(plac_insuff ~ preterm, data = birth,
    family = binomial(link = "log"))
exp(0.8722)

birth |>
  group_by(gestation) |>
  count(hypertension_gest,
        sga) |>
  ggplot(aes(x = gestation, y = n, group = hypertension_gest, fill = sga)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ hypertension_gest, scales = "free")

table(birth$hypertension_gest)


```


Additional cleaning:

```{r, echo = FALSE, results='hide'}

# contains subsequent pregnancies
# length(unique(birth$momid))

# drop subsequent pregnancies
birth_sorted <- birth |>
  arrange(momid, birthccyy, birthmm)

birth <- birth_sorted[match(unique(birth_sorted$momid), birth_sorted$momid), ]

# try to make long
birth_l <- birth |>
  pivot_longer(names_to = "exposure_week", cols = 16:367)

# tidy up
birth_l <- birth_l |>
  select(!c(statefilenumber, geo_score, full_date))

# create birth date
birth_l <- birth_l |>
  mutate(date = mdy(paste0(str_pad(birthmm, width = 2, pad = "0", side = "left"),
                           str_pad(birthdd, width = 2, pad = "0", side = "left"),
                           str_pad(birthccyy, width = 2, pad = "0", side = "left"))))

# dates of exposure
birth_l$gestation_week <- str_sub(birth_l$exposure_week, 
                                  start = (nchar(birth_l$exposure_week) - 1),
                                  end = nchar(birth_l$exposure_week)) |>
  as.numeric()

# make it person-week instead of person-pollutant-week
birth_l$pollutant <- str_sub(birth_l$exposure_week, start = 0, 
                             end = (nchar(birth_l$exposure_week) - 3))

# remove NA values, which are exposures which occur after birth
birth_l <- birth_l |>
  filter(!is.na(value))

# get the outcome by momid
preterm_momid <- birth_l |>
  select(c(momid, gestation, geoid, poverty_rate, race, ethn, race_ethn,
           diabetes_pre, hypertension_pre, momage_c)) |>
  distinct()

birth_pt <- birth_l |> # person-time
  pivot_wider(id_cols = c("momid", "date", "gestation_week"), 
              names_from = pollutant, values_from = value)
# this drops confounders, outcome, etc, but we can recover those later

# gives us the outcome (gestational age at birth)
birth_pt <- merge(birth_pt, preterm_momid, by = "momid")

birth_pt$gestation_wk_end <- birth_pt$date - (7 * birth_pt$gestation_week)

birth_pt$gestation_wk_start <- birth_pt$gestation_wk_end - 7

head(birth_pt)

```


Adding wildfire smoke data:

```{r, echo = FALSE, results='hide'}

hw <- read.csv("wf/HW_HYSPLIT_PM2p5_with_flag-2013-2016.csv") |>
  mutate(station = "HW") |>
  mutate(date = ymd(date))
bt <- read.csv("wf/BT_HYSPLIT_PM2p5_with_flag-2013-2016.csv") |>
  mutate(station = "BT") |>
  mutate(date = mdy(date))
lnd <- read.csv("wf/LND_HYSPLIT_PM2p5_with_flag-2013-2016.csv") |>
  mutate(station = "LND") |>
  mutate(date = ymd(date))

wf <- rbind(hw, bt, lnd)

# Hawthorne (SLC), Bountiful (Davis), Lindon (Utah)

# note: do not use PM2.5 from this csv, according to Heather
wf$smoke <- ifelse(wf$flag == "y", "smoke", "no smoke")

wf_dates <- wf |>
  filter(smoke == "smoke") |>
  select(date, station) # eventually, we'll combine all three counties and will need station

wf_dates$smoke <- 1

# needs to be a spatiotemporal join, although a crude one ## as of 9/2, it's just temporal
# - could use census data to start, based on county
#     - Davis (011) = Bountiful
#     - Utah (049) = Lindon
#     - Salt Lake (035) = Hawthorne
#     - Restrict analysis to these locations first

# get only births in counties with inversion models
birth_wf <- birth_pt |>
  mutate(county_fips = str_sub(geoid, start = 3, end = 5)) |>
  filter(county_fips %in% c("011", "049", "035")) |>
  mutate(wf_station = case_when(county_fips %in% c("011") ~ "BT",
                                county_fips == "049" ~ "LND",
                                county_fips == "035" ~ "HW"))

# probably the way to go is disaggregate to daily, then re-aggregate to weekly with n(inv_days)

birth_days <- setDT(birth_wf)[ , list(momid = momid, 
                                       date = seq(gestation_wk_start, 
                                                  gestation_wk_end, by = "day"),
                                       wf_station, gestation_week, #geoid,
                                       poverty_rate, race, ethn, race_ethn,
                                       diabetes_pre, hypertension_pre, momage_c),
                                by = 1:nrow(birth_wf)]

birth_days_wf <- merge(birth_days, wf_dates, by.x = c("date", "wf_station"), 
                       by.y = c("date", "station"), all.x = TRUE)

birth_days_wf$smoke <- ifelse(is.na(birth_days_wf$smoke), 0, birth_days_wf$smoke)

birth_days_wf <- birth_days_wf |>
  group_by(momid, gestation_week, smoke) |>
  tally()

# think I can just take the smoke count?
birth_days_wf <- birth_days_wf |>
  filter(smoke == 1) #|>
  # select(!smoke)

head(birth_days_wf)

birth_wf <- merge(birth_wf, birth_days_wf, by = c("momid", "gestation_week"), all.x = TRUE)

birth_wf$n <- ifelse(is.na(birth_wf$n), 0, birth_wf$n - 1)

birth_wf$smoke <- ifelse(is.na(birth_wf$smoke), 0, 1)

# table(birth_wf$n)
# prop.table(table(birth_wf$n != 0)) # proportion of pregnancy weeks with smoke exposure

```

```{r, echo = FALSE, results='hide'}

# light cleaning
birth_wf$preterm <- relevel(
  as.factor(ifelse(birth_wf$gestation <= 37, 
                   "preterm/early", "late/term")), ref = "late/term")

birth_wf$n <- as.factor(birth_wf$n)

birth_wf$gestation_week <- as.factor(birth_wf$gestation_week)

birth_wf$race_ethn <- relevel(as.factor(birth_wf$race_ethn), ref = "white")

birth_wf$early_preterm <- ifelse(birth_wf$gestation <= 37, 1, 0) # include "very" early and early

birth_wf$max_wf_pm <- ifelse(birth_wf$n != 0, birth_wf$max_pm, 0)
birth_wf$max_nonwf_pm <- ifelse(birth_wf$n == 0, birth_wf$max_pm, 0)

# how many person-weeks don't exist for later gestation?
aggregate(birth_wf$early_preterm, by = list(birth_wf$gestation_week), FUN = sum)

# only first 20 weeks; or not; using person-time, don't filter
birth_wf_20 <- birth_wf# |>
  # filter(gestation >= 20)

# check missingness
summary(birth_wf_20[which(birth_wf_20$gestation_week == 32), "max_wf_pm"])

# poverty is missing for 318 folks; fix later
# summary(birth_wf_20$poverty_rate)

# ggplot(birth_wf_20, aes(x = smoke, y = max_pm)) + geom_density()

```

DLNM model:

```{r, out.width="150%"}

# create crossbasis for exposure-lag-response
# wf-specific pm2.5
cb1.intx <- crossbasis(birth_wf_20$max_wf_pm, 
                      lag = 37, 
                      argvar = list(fun = "bs", knots = 4), 
                      arglag = list(fun = "bs", knots = 4))
summary(cb1.intx) # this describes the crossbasis functions and basis for the predictor and lag

# #### non wildfire pm2.5
# cb1.nonwf_pm25 <- crossbasis(birth_wf_20$max_nonwf_pm, 
#                       lag = 37, 
#                       argvar = list(fun = "ns", knots = 4), 
#                       arglag = list(fun = "ns", knots = 4))
# summary(cb1.nonwf_pm25) 

# smoke
cb1.wf <- crossbasis(birth_wf_20$smoke,
                      lag = 37,
                      # argvar = list(fun = "lin"),
                      arglag = list(fun = "ns", knots = 2))
summary(cb1.wf) # this describes the crossbasis functions and basis for the predictor and lag

# any PM2.5
cb1.pm25 <- crossbasis(birth_wf_20$max_pm, 
                      lag = 37, 
                      argvar = list(fun = "bs", knots = 4), 
                      arglag = list(fun = "bs", knots = 4))
summary(cb1.pm25) # this describes the crossbasis functions and basis for the predictor and lag

# model
model1 <- glm(early_preterm ~ cb1.intx + #cb1.nonwf_pm25,
                cb1.pm25 + cb1.wf, # +
                # diabetes_pre + hypertension_pre + momage_c,
                # poverty_rate + race_ethn, # adjusting for confounders
                family = "binomial", birth_wf_20)
summary(model1)

library(regclass)
VIF(model1)

crosspred(cb1.wf, model1, vcov = vcov(model1),
          coef = names(coef(model1)))

# 3 knots: ...
# 4 knots: 1043491


test <- glm(early_preterm ~ max_pm*smoke,# + max_wf_pm,
            data = birth_wf_20, family = "binomial")
summary(test)
```



```{r}
# get predictions for each exposure-lag
pred1.wf_pm25 <- crosspred(cb1.wf_pm25, model1, at = 0:10*20,#0:120, 
                       bylag = 1, cumul = TRUE, cen = 0)
plot(pred1.wf_pm25, col = "red",
     zlab = "Risk of PTB", 
     ylab = "Gestational week", xlab = "Smoke-specific PM2.5")

plot(pred1.wf_pm25, var = 200, #ylim = c(0.5, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")

# pred1.wf <- crosspred(cb1.wf, model1)#, at = 0:1, bylag = 1,
                       # cumul = TRUE, cen = 0)#, #at = 0:120, 
                       # bylag = 1, cen = 0)#, cumul = TRUE, cen = 0)
# plot(pred1.wf)

pred1.pm25 <- crosspred(cb1.pm25, model1, at = 0:10*20, 
                       bylag = 1, cumul = TRUE, cen = 0)
plot(pred1.pm25, col = "darkorange",
     zlab = "Risk of PTB", 
     ylab = "Gestational week", xlab = "PM2.5")

crosspred(cb1.wf, model1, at = 0:1, 
          bylag = 1, cumul = TRUE, cen = 0)

crosspred(cb1.wf, model1, vcov = vcov(model1),
          coef = names(coef(model1)))

names(coef(model1)[14:16])

coef(model1)[14:16]
vcov(model1)[14:16, 14:16]

parlist <- lapply(seq(cat), function(i) {
  coef <- coef(model1)[i,][-1]
  ind <- (i-1)*7+seq(6)+1
  vcov <- vcov(model1)[ind,ind]
  list(coef=coef, vcov=vcov)
})
names(parlist) <- cat

# prediction
cplist <- lapply(cat, function(x)
  crosspred(cb1.inv, coef=parlist[[x]]$coef, vcov=parlist[[x]]$vcov, at=1, 
    cumul=TRUE, cen=0)
)






# str(pred1.wf)

# full exposure-lag-response surface
plot(pred1.wf_pm25, zlab = "OR of preterm birth", 
     ylab = "Gestational week", xlab = "smoke-specific PM2.5",
     col = "white")

plot(pred1.pm25, var = 150)

# lag-response curves at specific exposure thresholds
# based on the lawer end of each AQI category
# https://www.airnow.gov/aqi/aqi-basics/

# axis labels
main_AQI50 = expression(paste("smoke PM"[2.5], 
                                 " = 9 µg/m" ^ 3, 
                                 " (AQI = 50)"))
main_AQI100 = expression(paste("smoke PM"[2.5], 
                                  " = 35 µg/m" ^ 3, 
                                  " (AQI = 100)"))
main_AQI150 = expression(paste("smoke PM"[2.5], 
                                  " = 55 µg/m" ^ 3, 
                                  " (AQI = 150)"))
main_AQI200 = expression(paste("smoke PM"[2.5], 
                                  " = 119 µg/m" ^ 3, 
                                  " (AQI = 200)"))
# curves # export with ht = 15
par(mfrow = c(4, 1))
plot(pred1.wf_pm25, var = 120, ylim = c(0.5, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI200)
plot(pred1.wf_pm25, var = 60, ylim = c(0.5, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI150)
plot(pred1.wf_pm25, var = 36, ylim = c(0.5, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI100)
plot(pred1.wf_pm25, var = 12, ylim = c(0.5, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI50)
dev.off()


# for any PM2.5
par(mfrow = c(4, 1))
plot(pred1.pm25, var = 120, ylim = c(0.85, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI200)
plot(pred1.pm25, var = 60, ylim = c(0.85, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI150)
plot(pred1.pm25, var = 40, ylim = c(0.85, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI100)
plot(pred1.pm25, var = 20, ylim = c(0.85, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week")#, main = main_AQI50)
dev.off()

```


Briefly, multinomial

```{r}

library(nnet)

birth_wf_20$preterm_cat <- case_when(birth_wf_20$gestation < 28 ~ "very early",
                                     birth_wf_20$gestation < 32 ~ "just early",
                                     birth_wf_20$gestation < 34 ~ "moderate",
                                     birth_wf_20$gestation < 37 ~ "late",
                                     birth_wf_20$gestation >= 37 ~ "term")
birth_wf_20$preterm_cat <- relevel(as.factor(birth_wf_20$preterm_cat), ref = "term")

model3 <- multinom(preterm_cat ~ cb1.intx + #cb1.nonwf_pm25,
                cb1.pm25 + cb1.wf, # +
              # diabetes_pre + hypertension_pre + momage_c,
              # poverty_rate + race_ethn, # adjusting for confounders
              birth_wf_20)
summary(model3)

# extract coef/vcov for various categories
cat <- c("very early", "just early", "moderate", "late") # w/o reference

cov_mat <- vcov(model3)

cov_mat_names <- colnames(cov_mat)

# colnames(cov_mat)[which(grepl(cat[1], colnames(cov_mat)) == TRUE)][-1] # not intercept, but all else

# cov_mat[]
# get the cov col/rows for each
which(grepl(cat[1], colnames(cov_mat)) == TRUE)[-1]

parlist <- lapply(seq(cat), function(i) {
  coef <- coef(model3)[i,][-1]
  ind <- which(grepl(cat[i], colnames(cov_mat)) == TRUE)[-1]
  #colnames(cov_mat)[which(grepl(cat[i], colnames(cov_mat)) == TRUE)][-1] #(i-1)*19+seq(6)+1
  vcov <- vcov(model3)[ind, ind] ###
  list(coef=coef, vcov=vcov)
})

parlist



str(cov_mat)
cov_mat[1:63, ]

names(parlist) <- cat

# prediction

for(i in 1:200) {
  cplist <- lapply(cat, function(x)
    crosspred(cb1.intx, coef=parlist[[x]]$coef, vcov=parlist[[x]]$vcov, at=i, 
              cumul=TRUE, cen=0)
  )
}
str(cplist)



cplist <- lapply(cat, function(x)
    crosspred(cb1.intx, coef=parlist[[x]]$coef, vcov=parlist[[x]]$vcov, at=1:20*10, 
              cumul=TRUE, cen=0)
  )
str(cplist)


cplist <- lapply(cat, function(x)
  crosspred(cb1.intx, coef=parlist[[x]]$coef, vcov=parlist[[x]]$vcov, at=1, 
    cumul=TRUE, cen=0)
)

we need

names(cplist) <- c("very early", "just early", "moderate", "late")

# now let's take this to dlnm functions and see if we can plot it
cplist


```




```{r}

### days of WF smoke exposure

summary(birth_wf$n)


cb_days <- crossbasis(birth_wf$n, 
                      lag = 37, 
                      argvar = list(fun = "bs", knots = 3), 
                      arglag = list(fun = "bs", knots = 3))
summary(cb_days) # this describes the crossbasis functions and basis for the predictor and lag

# model
model2 <- glm(early_preterm ~ cb_days,# +
                # diabetes_pre + hypertension_pre + momage_c,
                #poverty_rate + race_ethn, # adjusting for confounders
                family = "binomial", birth_wf_20)
summary(model2)

# ns: 1041806
# bs: 1041779

# prediction
pred1.wf_days <- crosspred(cb_days, model2, at = 0:7,#0:120, 
                           bylag = 1, cumul = TRUE, cen = 0)
plot(pred1.wf_days, zlab = "OR of preterm birth", 
     ylab = "Gestational week", xlab = "Days of smoke exposure / week",
     col = "purple")

plot(pred1.wf_days, var = 7, #ylim = c(0.5, 1.2), 
     ylab = "Odds ratios of preterm birth", 
     xlab = "Gestational week",
     main = "7 days of exposure")


```


```{r}

aggregate(birth_wf_20$gestation, by = list(birth_wf_20$smoke), FUN = mean)

table(birth_wf_20$smoke, birth_wf_20$early_preterm)

```





